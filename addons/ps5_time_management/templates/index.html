<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PS5 Time Management</title>
  <link rel="stylesheet" href="./globals.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toggle-switch { position: relative; display: inline-flex; height: 2rem; width: 3rem; align-items: center; border-radius: 9999px; transition: background-color 0.2s; cursor: pointer; }
    .toggle-switch.active { background-color: rgb(37 99 235); }
    .toggle-switch:not(.active) { background-color: rgba(255, 255, 255, 0.2); }
    .toggle-slider { display: inline-block; height: 1.25rem; width: 1.25rem; transform: translateX(0.375rem); border-radius: 9999px; background-color: white; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); transition: transform 0.2s; }
    .toggle-switch.active .toggle-slider { transform: translateX(1.625rem); }
  </style>
</head>
<body class="min-h-screen bg-background text-foreground">
  <div class="min-h-screen bg-background p-4 md:p-6 lg:p-8">
    <div class="mx-auto max-w-7xl space-y-6">
      <div class="flex items-center gap-3">
        <svg class="h-8 w-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <h1 class="text-3xl font-bold tracking-tight">PS5 Time Management</h1>
      </div>
      <p class="text-muted-foreground">Welcome to the PS5 Time Management add-on!</p>

      <div class="bg-card rounded-2xl shadow-none p-6">
        <div class="pb-3">
          <h2 class="flex items-center gap-2 text-lg font-semibold">
            <svg class="h-5 w-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            Console Status
            <span id="status-badge" class="ml-2 bg-secondary/80 text-secondary-foreground font-medium text-xs px-2.5 py-0.5 rounded-full">Loading…</span>
          </h2>
        </div>
        <div class="flex items-center gap-4">
          <img id="game-cover" class="hidden h-16 w-16 rounded-lg object-cover bg-muted" alt="Game" />
          <div class="space-y-1">
            <div class="flex items-center gap-2">
              <div id="players-line" class="text-sm text-foreground hidden"></div>
              <div id="game-line" class="text-sm text-foreground hidden"></div>
            </div>
          </div>
        </div>
        
      </div>

      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold tracking-tight pt-2 ml-2 md:ml-4">Users</h2>
          <button onclick="loadUsers()" class="inline-flex items-center gap-2 rounded-full bg-primary/90 hover:bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Refresh
          </button>
        </div>
        <div id="users-container" class="grid gap-4"></div>
        <div id="loading" class="text-sm text-muted-foreground">Loading users…</div>
        <div id="error" class="hidden text-sm text-destructive"></div>
      </div>
    </div>
  </div>

  <script>
    function badgeFor(power) {
      if (!power) return 'bg-zinc-700 text-white';
      power = String(power).toUpperCase();
      if (power === 'AWAKE') return 'bg-green-600 text-white';
      if (power === 'STANDBY') return 'bg-zinc-600 text-white';
      return 'bg-zinc-700 text-white';
    }
    async function fetchStatus(){
      try {
        const r = await fetch('./api/status');
        const s = await r.json();
        const badge = document.getElementById('status-badge');
        const playersLine = document.getElementById('players-line');
        const gameLine = document.getElementById('game-line');
        const cover = document.getElementById('game-cover');
        const power = (s && s.power) || 'UNKNOWN';
        badge.className = 'font-medium text-xs px-2.5 py-0.5 rounded-full ' + badgeFor(power);
        badge.textContent = power;

        // Players
        const players = (s && s.players) || (s && s.active_sessions && s.active_sessions.map(a=>a.user)) || [];
        if (players && players.length) {
          playersLine.textContent = 'Players: ' + players.join(', ');
          playersLine.classList.remove('hidden');
        } else {
          playersLine.classList.add('hidden');
        }
        // Game title + cover
        const titleName = (s && (s.title_name || (s.title && s.title.name)));
        const titleImage = (s && (s.title_image || (s.title && s.title.image)));
        if (titleName || titleImage) {
          gameLine.textContent = titleName ? 'Game: ' + titleName : '';
          gameLine.classList.toggle('hidden', !titleName);
          if (titleImage) {
            cover.src = titleImage; cover.classList.remove('hidden');
          } else { cover.classList.add('hidden'); }
        } else {
          gameLine.classList.add('hidden'); cover.classList.add('hidden');
        }
      } catch(e){ /* ignore */ }
    }

    function icon(name){
      if(name==='clock') return '<svg class="h-3.5 w-3.5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
      if(name==='calendar') return '<svg class="h-3.5 w-3.5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>';
      return '';
    }

    function fmtRemaining(mins){
      if(!mins || mins <= 0) return '0m';
      if(mins % 60 === 0) return (mins/60)+'h';
      if(mins > 60) return Math.floor(mins/60)+'h '+(mins%60)+'m';
      return mins+'m';
    }

    function cardHtml(user, stats, allowed){
      return `
      <div class="bg-card rounded-2xl shadow-none"> 
        <div class="p-6 pb-3">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">${user}</h3>
            <div class="flex items-center gap-3">
              <span class="text-sm text-muted-foreground">Access</span>
              <button class="toggle-switch ${allowed ? 'active' : ''}" onclick="toggleAccess(this, '${user}')" role="switch" aria-checked="${!!allowed}"><span class="toggle-slider"></span></button>
              <a href="./stats/${user}" class="inline-flex items-center gap-1.5 rounded-full bg-blue-600 hover:bg-blue-500 text-xs h-8 px-3 font-medium text-white"><svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>View Stats</a>
            </div>
          </div>
        </div>
        <div class="px-6 pb-6 space-y-3">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2"> 
            <div class="bg-secondary/30 rounded-xl p-3"><div class="flex items-center gap-1.5 text-muted-foreground mb-1">${icon('clock')}<span class="text-xs font-medium">Daily</span></div><p class="text-xl font-bold text-foreground">${stats.daily}m</p></div>
            <div class="bg-secondary/30 rounded-xl p-3"><div class="flex items-center gap-1.5 text-muted-foreground mb-1">${icon('calendar')}<span class="text-xs font-medium">Weekly</span></div><p class="text-xl font-bold text-foreground">${stats.weekly}m</p></div>
            <div class="bg-secondary/30 rounded-xl p-3"><div class="flex items-center gap-1.5 text-muted-foreground mb-1">${icon('calendar')}<span class="text-xs font-medium">Monthly</span></div><p class="text-xl font-bold text-foreground">${stats.monthly}m</p></div>
            <div class="bg-secondary/30 rounded-xl p-3"><div class="flex items-center gap-1.5 text-muted-foreground mb-1">${icon('clock')}<span class="text-xs font-medium">Remaining</span></div><p class="text-xl font-bold text-orange-400">${fmtRemaining(stats.remaining || 0)}</p></div>
          </div>
        </div>
      </div>`
    }

    async function loadUsers(){
      const cont = document.getElementById('users-container');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      if (loading) loading.classList.remove('hidden');
      if (error) error.classList.add('hidden');
      cont.innerHTML='';
      try{
        const r = await fetch('./api/users'); const data = await r.json();
        const users = data.users || [];
        for (const u of users){
          const [statsResp, accessResp] = await Promise.all([
            fetch(`./api/users/${u}/stats`),
            fetch(`./api/access/${u}`)
          ]);
          const stats = await statsResp.json();
          const access = await accessResp.json();
          cont.insertAdjacentHTML('beforeend', cardHtml(u, stats, !!access.allowed));
        }
      }catch(e){ if (error){ error.textContent = 'Failed to load users'; error.classList.remove('hidden'); } }
      finally{ if (loading) loading.classList.add('hidden'); }
    }

    async function toggleAccess(btn, user){
      btn.classList.toggle('active');
      const allowed = btn.classList.contains('active');
      btn.setAttribute('aria-checked', allowed);
      try{ await fetch(`./api/access/${user}`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({allowed})}); }catch(e){}
    }
    async function refreshUser(user){ try{ await fetch(`./api/refresh/${user}`, {method:'POST'}); loadUsers(); }catch(e){} }
    async function clearUserStats(user){ if(!confirm(`Clear all stats for ${user}?`)) return; try{ await fetch(`./api/cleanup/${user}`, {method:'POST'}); loadUsers(); }catch(e){} }

    fetchStatus(); loadUsers(); setInterval(fetchStatus, 15000);

    // Removed temporary cache viewer
  </script>
</body>
</html>


